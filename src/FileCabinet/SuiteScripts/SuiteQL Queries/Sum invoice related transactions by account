with invs as (
 
select id
from transaction
where recordtype='invoice' and trandate >= to_date('01/01/2024', 'MM/DD/YYYY')
 
)
, Accounts as (
        select *
        from (select inv.id                        as invintid,
                     inv.tranid                    as invid,
                     inv.foreigntotal              as invamount,
                     t.id,
                     t.tranid,
                     tl.linesequencenumber,
                     t.recordtype,
                     tl.expenseaccount             as accountid,
                     BUILTIN.DF(tl.expenseaccount) as accountname,
                     ll.foreignamount              as amount
              from nexttransactionlinelink ll
                       join transaction inv on ll.previousdoc = inv.id
--                     join transactionline il on il.transaction = inv.id
                       join transaction t on t.id = ll.nextdoc
                       join transactionline tl on tl.transaction = t.id
                       join invs i on i.id = ll.previousdoc

              union all

              select nvl(tl.custcol_invoice, t.custbody_invoice)            as invintid,
                     inv.tranid                    as invid,
                     inv.foreigntotal              as invamount,
                     t.id,
                     t.tranid,
                     tl.linesequencenumber,
                     t.recordtype,
                     tl.expenseaccount             as accountid,
                     BUILTIN.DF(tl.expenseaccount) as accountname,
                     tl.foreignamount              as amount
              from transaction t
                       join transactionline tl on tl.transaction = t.id
                       join invs i on i.id = nvl(tl.custcol_invoice, t.custbody_invoice)
                       join transaction inv on inv.id = i.id

              union all

              select tl.custcol_invoice_link       as invintid,
                     inv.tranid                    as invid,
                     inv.foreigntotal              as invamount,
                     t.id,
                     t.tranid,
                     tl.linesequencenumber,
                     t.recordtype,
                     tl.expenseaccount             as accountid,
                     BUILTIN.DF(tl.expenseaccount) as accountname,
                     tl.foreignamount              as amount
              from transaction t
                       join transactionline tl on tl.transaction = t.id
                       join invs i on i.id = tl.custcol_invoice_link
                       join transaction inv on inv.id = i.id

              union all

              select t.custbody_invoice            as invintid,
                     inv.tranid                    as invid,
                     inv.foreigntotal              as invamount,
                     t.id,
                     t.tranid,
                     tl.linesequencenumber,
                     t.recordtype,
                     tl.expenseaccount             as accountid,
                     BUILTIN.DF(tl.expenseaccount) as accountname,
                     tl.foreignamount              as amount
              from transaction t
                       join transactionline tl on tl.transaction = t.id
                       join invs i on i.id = t.custbody_invoice
                       join transaction inv on inv.id = i.id)
        order by id,
                 linesequencenumber
)

 
select
--  invid,
  accountid
, accountname
, sum( amount)  sumAmount
from Accounts
group by 
--  invid,
  accountid
, accountname
 
order by 3 desc --1 desc, 3 asc